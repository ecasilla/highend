import LoginActions from '../actions/LoginActions';
import Firebase from 'firebase';
import FBService from './FireBaseService';

class AuthService {
  constructor(){
   this.FireBaseService = new FBService().ref();
  }

  errorcheck(error){
    switch (error.code) {
      case "INVALID_EMAIL":
        console.log("The specified user account email is invalid.");
        break;
      case "INVALID_PASSWORD":
        console.log("The specified user account password is incorrect.");
        break;
      case "INVALID_USER":
        console.log("The specified user account does not exist.");
        break;
      case "EMAIL_TAKEN":
        console.log("Email has been taken");
        break;
      default:
        console.log("Error logging user in:", error);
    }
  }

  login(user) {
    console.log(user,"login called");
    return new Promise( (resolve,reject) => {
      this.FireBaseService.authWithPassword({
        email    : user.email,
        password : user.password
      }, (error, authData) => {
        if (error) {
          this.errorcheck(error);
        }else{
          return authData;
        }
      });
    });
  }

  logout() {
    FireBaseService.unauth();
    LoginActions.logoutUser();
  }

  signup(payload) {
    return new Promise( (resolve,reject) => {
      FireBaseService.createUser(payload,(error, userData) => {
        if (error) {
          errorcheck(error);
        } else {
          console.log("Successfully created user account with uid:", userData.uid);
          return userData;
        }
      });
    });
  }

  createUserAndLogin(userObj) {
    return signup(userObj)
    .then(() => {
      return login(userObj);
    });
  }

  thirdPartyLogin(provider){
    return new Promise( (resolve,reject) => {
      FireBaseService.authWithOAuthPopup(provider,(err, user) => {
        if (err) { reject(err); }
        if (user) { resolve(user);}
      });
    });
  }

  handleAuth(loginPromise){
    return loginPromise
    .then(response => {
      var jwt = response.id_token;
      LoginActions.loginUser(jwt);
      return true;
    });
  }
}

export default new AuthService();
